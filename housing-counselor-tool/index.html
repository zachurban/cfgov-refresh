<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Find a Housing Counselor Tool - cfgov-refresh</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../css/overrides.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Find a Housing Counselor Tool";
    var mkdocs_page_input_path = "housing-counselor-tool.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> cfgov-refresh</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../installation/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../usage/">Usage</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Pages and Components</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../atomic-structure/">Atomic Structure and Design</a>
                </li>
                <li class="">
                    
    <a class="" href="../editing-components/">Creating and Editing Components</a>
                </li>
                <li class="">
                    
    <a class="" href="../migrations/">Django and Wagtail Migrations</a>
                </li>
                <li class="">
                    
    <a class="" href="../mega-menu/">Editing the Mega Menu</a>
                </li>
                <li class="">
                    
    <a class="" href="../forms-in-wagtail/">Forms in Wagtail Page Context</a>
                </li>
                <li class="">
                    
    <a class="" href="../wagtail-pages/">Wagtail Pages</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Supporting Features</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../caching/">Caching</a>
                </li>
                <li class="">
                    
    <a class="" href="../feature-flags/">Feature Flags</a>
                </li>
                <li class="">
                    
    <a class="" href="../satellite-repos/">Satellite Repos</a>
                </li>
                <li class="">
                    
    <a class="" href="../split-testing/">Split Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../translation/">Translation</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Testing</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../browser-acceptance-tests/">Browser/Acceptance Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../javascript-unit-tests/">JavaScript Unit Testing</a>
                </li>
                <li class="">
                    
    <a class="" href="../python-unit-tests/">Python Unit Testing</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Contributing</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../branching-merging/">Branching and Merging</a>
                </li>
                <li class="">
                    
    <a class="" href="../contributing-docs/">Contributing to the Docs</a>
                </li>
                <li class="">
                    
    <a class="" href="../development-tips/">Development Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../travis/">How We Use Travis CI</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Public APIs and Data</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../ask-cfpb/">Ask CFPB</a>
                </li>
                <li class="">
                    
    <a class="" href="../consumer-complaint-database/">Consumer Complaints</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Find a Housing Counselor Tool</a>
    <ul class="subnav">
            
    
        <ul>
        
            <li><a class="toctree-l4" href="#housing-counselor-data-processing">Housing Counselor Data Processing</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../hmda/">HMDA Data</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">cfgov-refresh</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Public APIs and Data &raquo;</li>
        
      
    
    <li>Find a Housing Counselor Tool</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/cfpb/cfgov-refresh/edit/master/docs/housing-counselor-tool.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="find-a-housing-counselor">Find a Housing Counselor<a class="headerlink" href="#find-a-housing-counselor" title="Permanent link">¶</a></h1>
<p>The <a href="https://www.consumerfinance.gov/find-a-housing-counselor/">Find a Housing Counselor tool</a> allows users to search for HUD-approved housing counselors.
Users enter a U.S. ZIP code, and the tool returns a list of the ten housing counselors nearest to that ZIP code location.
The page also displays a map of the results using Mapbox.</p>
<p>When the user enters a ZIP code in the page's search box, the <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/views.py#L84">Django view</a> fetches a JSON file of the results from our Amazon S3 bucket.
The results are inserted into the <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/jinja2/housing_counselor/index.html">page template</a> and the <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/unprocessed/apps/find-a-housing-counselor/js/common.js">Mapbox map</a>.
The page also contains a link to a PDF version of the results, which is also stored in S3.
The files are publicly accessible, so the tool can run on localhost or in a container without any change in behavior.</p>
<p>This page documents the process we use to generate the JSON and PDF files the Find a Housing Counselor tool relies on.</p>
<h2 id="housing-counselor-data-processing">Housing Counselor Data Processing<a class="headerlink" href="#housing-counselor-data-processing" title="Permanent link">¶</a></h2>
<p>The tool gets its data from the U.S. Department of Housing and Urban Development (HUD).
HUD provides an <a href="https://data.hud.gov/housing_counseling.html">API</a> to their list of approved counseling agencies.
A daily job, <code>cf.gov-housing-counselor-data</code> on our external Jenkins server,
queries HUD data and produces the JSON and PDF files we use for the Find a Housing Counselor tool.
It performs the following steps, each of which is optional
and configured using parameters before starting the job.</p>
<ol>
<li><a href="#geocode-zip-codes">Geocode ZIP codes</a> (<code>GEOCODE_ZIPCODES</code>)</li>
<li><a href="#generate-json-files">Generate JSON files</a> (<code>MAKE_JSON</code>)</li>
<li><a href="#generate-html-files">Generate HTML files</a> (<code>MAKE_HTML</code>)</li>
<li><a href="#generate-pdfs">Generate PDFs</a> (<code>MAKE_PDF</code>)</li>
<li><a href="#upload-to-s3">Upload to S3</a> (<code>UPLOAD_TO_S3</code>)</li>
</ol>
<h3 id="geocode-zip-codes">Geocode ZIP codes<a class="headerlink" href="#geocode-zip-codes" title="Permanent link">¶</a></h3>
<p>The <code>GEOCODE_ZIPCODES</code> step generates a file of all ZIP codes in the United States and their location latitude and longitude and saves it in the Jenkins workspace.
By default, this step is not enabled.
Since ZIP code geographical information rarely changes, we run this step rarely by manually enabling the option in the Jenkins job.</p>
<p>If enabled, this step calls the <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/management/commands/hud_geocode_zipcodes.py"><code>hud_geocode_zipcodes</code></a> management command.
The management command in turn calls the <code>BulkZipCodeGeocoder</code> in <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/geocoder.py"><code>geocoder.py</code></a>.
<code>BulkZipCodeGeocoder</code> uses the <a href="https://www.mapbox.com/">Mapbox</a> geocoding API to determine which 5-digit number sequences are ZIP codes and fetch their latitude and longitude values.
The management command inserts this data into a CSV and saves it to <code>./zipcodes.csv</code> on the Jenkins job workspace.</p>
<p>The generated file looks like this:</p>
<pre class="highlight"><code class="language-csv">12305,42.81,-73.94
12306,42.77,-73.96
12307,42.81,-73.93
12308,42.82,-73.93
12309,42.81,-73.91
12325,42.88779,-73.99597
12345,42.80856,-74.02737</code></pre>

<h3 id="generate-json-files">Generate JSON files<a class="headerlink" href="#generate-json-files" title="Permanent link">¶</a></h3>
<p>When enabled, the <code>MAKE_JSON</code> step generates a JSON file of housing counselor data for each ZIP code in the U.S.
Each file contains the ten results geographically nearest to the ZIP code's latitude and longitude.
This step is enabled by default.</p>
<p>This step calls the <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/management/commands/hud_generate_json.py"><code>hud_generate_json</code></a> management command,
which performs the following steps:</p>
<ol>
<li>fetch agency listings from HUD</li>
<li>clean the results</li>
<li>fill in any missing latitude and longitude values</li>
<li>create files of the 10 nearest results for each U.S. ZIP code</li>
</ol>
<h4 id="fetch-agency-listings">Fetch agency listings<a class="headerlink" href="#fetch-agency-listings" title="Permanent link">¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/fetcher.py"><code>fetcher.py</code></a></em>)</p>
<p>Request every housing counselor in HUD's database
with a request to <code>https://data.hud.gov/Housing_Counselor/searchByLocation?Lat=38.8951&amp;Long=-77.0367&amp;Distance=5000</code>.</p>
<p>It returns thousands of results like this:</p>
<pre class="highlight"><code class="language-json">{
    &quot;services&quot;: &quot;DFC,FBC,PPC,RHC&quot;,
    &quot;languages&quot;: &quot;ENG,SPA&quot;,
    &quot;agc_STATUS&quot;: &quot;A&quot;,
    &quot;agc_SRC_CD&quot;: &quot;HUD&quot;,
    &quot;counslg_METHOD&quot;: &quot;Face to Face Counseling,Group Counseling,Phone Counseling&quot;,
    &quot;agcid&quot;: &quot;80790&quot;,
    &quot;adr1&quot;: &quot;1234 N. Example St.&quot;,
    &quot;adr2&quot;: &quot; &quot;,
    &quot;city&quot;: &quot;SPRINGFIELD&quot;,
    &quot;email&quot;: &quot;counselor@example.org&quot;,
    &quot;fax&quot;: &quot;999-888-7777&quot;,
    &quot;nme&quot;: &quot;EXAMPLE COMMUNITY HOUSING SERVICES&quot;,
    &quot;phone1&quot;: &quot;111-222-3333&quot;,
    &quot;statecd&quot;: &quot;MI&quot;,
    &quot;weburl&quot;: &quot;www.example.org&quot;,
    &quot;zipcd&quot;: &quot;48219-8888&quot;,
    &quot;agc_ADDR_LATITUDE&quot;: &quot;42.442658&quot;,
    &quot;agc_ADDR_LONGITUDE&quot;: &quot;-83.28329&quot;,
    &quot;parentid&quot;: &quot;81228&quot;,
    &quot;county_NME&quot;: &quot;&quot;,
    &quot;phone2&quot;: &quot; &quot;,
    &quot;mailingadr1&quot;: &quot;1234 N. Example St.&quot;,
    &quot;mailingadr2&quot;: &quot; &quot;,
    &quot;mailingcity&quot;: &quot;SPRINGFIELD&quot;,
    &quot;mailingzipcd&quot;: &quot;48219-8888&quot;,
    &quot;mailingstatecd&quot;: &quot;MI&quot;,
    &quot;state_NME&quot;: &quot;Michigan&quot;,
    &quot;state_FIPS_CODE&quot;: null,
    &quot;faithbased&quot;: &quot;N&quot;,
    &quot;colonias_IND&quot;: &quot;Y&quot;,
    &quot;migrantwkrs_IND&quot;: &quot;N&quot;
},</code></pre>

<h4 id="clean-the-results">Clean the results<a class="headerlink" href="#clean-the-results" title="Permanent link">¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/fetcher.py"><code>fetcher.py</code></a></em>)</p>
<p>We replace the <code>languages</code> value with the full language names.
We replace the <code>services</code> value with fully spelled out service descriptions.
Both of these mappings come from the HUD API.</p>
<p>(<em>in <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/cleaner.py"><code>cleaner.py</code></a></em>)</p>
<p>Clean the data: Convert latitude and longitude values to float values.
Convert the the city and organization name to title case.
Ensure email appears to be an email (otherwise leave it blank).
If a URL value is present, ensure it begins with <code>http://</code>.</p>
<h4 id="backfill-missing-latitude-and-longitude-values">Backfill missing latitude and longitude values<a class="headerlink" href="#backfill-missing-latitude-and-longitude-values" title="Permanent link">¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/geocoder.py"><code>geocoder.py</code></a></em>)</p>
<p>If any counselor records are missing their latitude or longitude data,
we fill in those values with the lat/long location of the agency's ZIP code.
This uses the data file created in the Geocode ZIP Codes stage of the Jenkins job (<a href="#geocode-zip-codes">above</a>).</p>
<h4 id="create-collections-of-results-by-zip-code">Create collections of results by ZIP code<a class="headerlink" href="#create-collections-of-results-by-zip-code" title="Permanent link">¶</a></h4>
<p>(<em>in <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/generator.py"><code>generator.py</code></a></em>)</p>
<p>Create an in-memory SQLite database and define a <code>distance_in_miles</code> function in it.
Fill the database with a three-column table:
For each counselor in the list, include its latitude and longitude (both in radians) and
all of its information from the HUD API as a JSON text string.</p>
<p>For each ZIP code in the U.S., query the database to find the 10 closest housing counselors to the lat/long of that ZIP.
Put the information in a JSON structure like this (but with ten results instead of one):</p>
<pre class="highlight"><code class="language-json">{
    &quot;zip&quot;: {
        &quot;lat&quot;: 42.80856,
        &quot;lng&quot;: -74.02737,
        &quot;zipcode&quot;: &quot;12345&quot;
    },
    &quot;counseling_agencies&quot;: [{
        &quot;adr1&quot;: &quot;1234 N. Example St.&quot;,
        &quot;state_FIPS_CODE&quot;: null,
        &quot;adr2&quot;: &quot; &quot;,
        &quot;zipcd&quot;: &quot;48219-8888&quot;,
        &quot;mailingcity&quot;: &quot;Springfield&quot;,
        &quot;weburl&quot;: &quot;http://www.example.org&quot;,
        &quot;agc_STATUS&quot;: &quot;A&quot;,
        &quot;city&quot;: &quot;Springfield&quot;,
        &quot;languages&quot;: [&quot;English&quot;, &quot;Spanish&quot;],
        &quot;faithbased&quot;: &quot;N&quot;,
        &quot;mailingstatecd&quot;: &quot;MI&quot;,
        &quot;email&quot;: &quot;counselor@example.org&quot;,
        &quot;fax&quot;: &quot;999-888-7777&quot;,
        &quot;phone1&quot;: &quot;111-222-3333&quot;,
        &quot;distance&quot;: 5.430720023569205,
        &quot;phone2&quot;: &quot; &quot;,
        &quot;agc_ADDR_LATITUDE&quot;: 42.442658,
        &quot;agcid&quot;: &quot;80790&quot;,
        &quot;agc_SRC_CD&quot;: &quot;HUD&quot;,
        &quot;nme&quot;: &quot;Example Community Housing Services&quot;,
        &quot;migrantwkrs_IND&quot;: &quot;N&quot;,
        &quot;parentid&quot;: &quot;82772&quot;,
        &quot;services&quot;: [&quot;Mortgage Delinquency and Default Resolution Counse&quot;, &quot;Home Improvement and Rehabilitation Counseling&quot;, &quot;Pre-purchase Counseling&quot;, &quot;Pre-purchase Homebuyer Education Workshops&quot;, &quot;Rental Housing Counseling&quot;],
        &quot;counslg_METHOD&quot;: &quot;Face to Face Counseling,Group Counseling,Phone Counseling&quot;,
        &quot;county_NME&quot;: &quot;&quot;,
        &quot;mailingadr1&quot;: &quot;1234 N. Example St.&quot;,
        &quot;statecd&quot;: &quot;MI&quot;,
        &quot;mailingadr2&quot;: &quot; &quot;,
        &quot;mailingzipcd&quot;: &quot;48219-8888&quot;,
        &quot;state_NME&quot;: &quot;Michigan&quot;,
        &quot;agc_ADDR_LONGITUDE&quot;: -83.28329,
        &quot;colonias_IND&quot;: &quot;Y&quot;
    }]
}</code></pre>

<p>Save the resulting JSON files on the Jenkins job workspace, in a <code>jsons</code> directory, e.g. <code>jsons/12345.json</code>.</p>
<h3 id="generate-html-files">Generate HTML files<a class="headerlink" href="#generate-html-files" title="Permanent link">¶</a></h3>
<p>When enabled, the <code>MAKE_HTML</code> step generates an HTML page of housing counselor results, including styles,
for each file created in the previous step.
It saves them in an <code>htmls</code> directory on the Jenkins job workspace.
This step is enabled by default.</p>
<p>This step calls the <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/management/commands/hud_generate_html.py"><code>hud_generate_html</code></a> management command,
which calls HTML generation code in <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/generator.py"><code>generator.py</code></a>.
Django renders the <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/housing_counselor/templates/housing_counselor/pdf_selfcontained.html"><code>housing_counselor/pdf_selfcontained.html</code></a> template with the housing counselor data from each JSON file.
We save the resulting HTML files on the Jenkins job workspace, in a <code>htmls</code> directory, e.g. <code>htmls/12345.html</code>.</p>
<h3 id="generate-pdfs">Generate PDFs<a class="headerlink" href="#generate-pdfs" title="Permanent link">¶</a></h3>
<p>When enabled, the <code>MAKE_PDF</code> step generates a PDF of each file created in the previous step.
It saves them in a <code>pdfs</code> directory on the Jenkins job workspace.
This step is enabled by default.</p>
<p>This step uses a HTML to PDF conversion command line tool.
We run the conversion on each file in the <code>htmls</code> directory, generating a PDF version of each, e.g. <code>pdfs/12345.pdf</code>.</p>
<h3 id="upload-to-s3">Upload to S3<a class="headerlink" href="#upload-to-s3" title="Permanent link">¶</a></h3>
<p>When enabled, the <code>UPLOAD_TO_S3</code> step uploads the contents of the <code>jsons</code> and <code>pdfs</code> directories to an Amazon S3 bucket where it can be accessed by consumerfinance.gov.
This step is enabled by default.</p>
<p>The files are publicly accessible, e.g.:</p>
<ul>
<li><a href="https://files.consumerfinance.gov/a/assets/hud/jsons/12345.json">https://files.consumerfinance.gov/a/assets/hud/jsons/12345.json</a></li>
<li><a href="https://files.consumerfinance.gov/a/assets/hud/pdfs/12345.pdf">https://files.consumerfinance.gov/a/assets/hud/pdfs/12345.pdf</a></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../hmda/" class="btn btn-neutral float-right" title="HMDA Data">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../consumer-complaint-database/" class="btn btn-neutral" title="Consumer Complaints"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/cfpb/cfgov-refresh/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../consumer-complaint-database/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../hmda/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
